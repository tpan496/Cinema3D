<html>

<head>
    <title> EXP cinema</title>
    <link rel="stylesheet" href="css/index.css">
</head>
Eric Bachman is a Lying Fuck
<div class="row">
<body style="background-color:#809AAD">
    <div div id="column3" style="float:right; margin:0;width:33%; ">
    <div class="chat">
        <input type="text" class="chat-name" placeholder="Enter your name" value=""style="background-color:#A0C4DE;height:75px">
        <div class="chat-messages"style="background-color:#A0C4DE"></div>
        <textarea class="chat-textarea" rows="10"placeholder="Type your message"style="background-color:#A0C4DE"></textarea>
        <div class="chat-status">
            Status: <span>Idle</span>
        </div>
    </div>
  </div>
  <div id="column1" style="float:right; margin:0; width:66%;">
    <div class="video">
        <div class="video-playlist" style="background-color:#A0C4DE; width:700px ;height:520px"></div>
        <input class="video-input" type="text" placeholder="Enter youtube url"style="background-color:#A0C4DE;width:700px">
        <div id="video-placeholder" ></div>
    </div>
    <button id="hostButton" type="button">Become host</button>
    <script src="/socket.io/socket.io.js"></script>
</div>
    <script>
        // Video Player
        var player;
        var playerIsReady = false;

        var tag = document.createElement('script');

        tag.src = "https://www.youtube.com/iframe_api";
        var firstScriptTag = document.getElementsByTagName('script')[0];
        firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);

        // Establish socket
        try {
            var socket = io.connect();
        } catch (e) {
            // Set status to warn user
        }

        // Test button
        document.getElementById("hostButton").onclick = function () {
            socket.emit('input_host_request', 1);
        };

        // Emit socket after api is ready
        function onYouTubeIframeAPIReady() {
            if (socket != null) {
                socket.emit('input_player_status', { status: 1 });
                console.log('loaded');
            }
        };

        function sendProgress() {
            if (playerIsReady) {
                if (socket !== undefined) {
                    socket.emit('input_video_progress', { time: player.getCurrentTime() });
                }
                var delay = setTimeout(function () {
                    sendProgress();
                    clearInterval(delay);
                }, 1000);
            }
        };
        function onPlayerReady(event) {
            event.target.playVideo();
            playerIsReady = true;
            sendProgress();
        }

        // 5. The API calls this function when the player's state changes.
        //    The function indicates that when playing a video (state=1),
        //    the player should play for six seconds and then stop.
        var done = false;
        function onPlayerStateChange(event) {
            if (event.data == YT.PlayerState.PLAYING && !done) {
                done = true;
            }
        }
        function stopVideo() {
            player.stopVideo();
        }
        (function () {
            var getNode = function (s) {
                return document.querySelector(s);
            },
                status = getNode('.chat-status span'),
                messages = getNode('.chat-messages'),
                textarea = getNode('.chat textarea'),
                chatName = getNode('.chat-name'),
                statusDefault = status.textContent,
                playlist = getNode('.video-playlist'),
                playlistInput = getNode('.video-input');

            setStatus = function (s) {
                status.textContent = s;
                if (s !== statusDefault) {
                    var delay = setTimeout(function () {
                        setStatus(statusDefault);
                        clearInterval(delay);
                    }, 5000);
                }
            };

            setStatus('Testing...');

            if (socket != undefined) {
                console.log('ok');
                // Listen for output for chat
                socket.on('output_chat_message', function (payload) {
                    if (payload.length) {
                        // Loop through messages
                        for (var x = 0; x < payload.length; x = x + 1) {
                            var message = document.createElement('div');
                            message.setAttribute('class', 'chat-message');
                            message.textContent = payload[x].name + ': ' + payload[x].message;

                            // Append
                            messages.appendChild(message);
                            messages.insertBefore(message, messages.firstChild);
                        }
                    }
                });

                // Listen for output for video
                socket.on('output_video_url', function (payload) {
                    if (payload.length) {
                        // Loop through messages
                        for (var x = 0; x < payload.length; x = x + 1) {
                            var url = document.createElement('div');
                            url.setAttribute('class', 'video_url');
                            url.textContent = payload[x].url;

                            // Append
                            playlist.appendChild(url);
                            playlist.insertBefore(url, playlist.firstChild);
                        }
                    }
                });

                // Listen for a status
                socket.on('status', function (payload) {
                    setStatus((typeof payload === 'object') ? payload.message : payload);
                    if (payload.clear === true) {
                        textarea.value = '';
                    }
                });
                // Listen for keydown
                textarea.addEventListener('keydown', function (event) {
                    var self = this,
                        name = chatName.value;
                    if (event.which === 13 && event.shiftKey === false) {
                        socket.emit('input_chat_message', {
                            name: name,
                            message: self.value
                        });
                    }
                });

                playlistInput.addEventListener('keydown', function (event) {
                    var self = this,
                        name = chatName.value;
                    if (event.which === 13 && event.shiftKey === false) {
                        socket.emit('input_video_url', {
                            name: name,
                            url: self.value
                        })
                    }
                });
                var self = this;
                socket.on('output_video_id', function (payload) {
                    console.log('new player');
                    if(player !== undefined){
                        player.destroy();
                        playerIsReady = false;
                    }
                    self.player = new YT.Player('video-placeholder', {
                        height: '390',
                        width: '640',
                        videoId: payload.id,
                        playerVars: { 'autoplay': 1, 'controls': 1 },
                        events: {
                            'onReady': self.onPlayerReady,
                            'onStateChange': self.onPlayerStateChange
                        }
                    });
                });

                socket.on('output_video_progress', function (payload) {
                    console.log('force update recieved' + payload.time);
                    if (playerIsReady) {
                        player.seekTo(payload.time, true);
                    }
                });
            }
        })();
    </script>
</body>
</div>

</html>
