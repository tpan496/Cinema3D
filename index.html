<html>

<head>
    <title> EXP cinema</title>
    <link rel="stylesheet" href="css/index.css">
</head>

<body>
    <div class="chat">
        <input type="text" class="chat-name" placeholder="Enter your name" value="">
        <div class="chat-messages"></div>
        <textarea class="chat-textarea" placholder="Type your message"></textarea>
        <div class="chat-status">
            Status: <span>Idle</span>
        </div>
    </div>
    <div class="video">
        <div class="video-playlist"></div>
        <input class="video-input" type="text" placeholder="Enter youtube url">
        <div id="video-placeholder"></div>
    </div>
    <button id="host-button" type="button">Become host</button>
    <div class="host-id"></div>
    <script src="/socket.io/socket.io.js"></script>
    <script>
        // Video Player
        var YTPlayer;
        var YTPlayerIsReady = false;
        var YTPlayerStatus;

        var tag = document.createElement('script');

        tag.src = "https://www.youtube.com/iframe_api";
        var firstScriptTag = document.getElementsByTagName('script')[0];
        firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);

        var getNode = function (s) {
            return document.querySelector(s);
        },
            status = getNode('.chat-status span'),
            messages = getNode('.chat-messages'),
            textarea = getNode('.chat textarea'),
            chatName = getNode('.chat-name'),
            statusDefault = status.textContent,
            playlist = getNode('.video-playlist'),
            playlistInput = getNode('.video-input'),
            hostId = getNode('.host-id');

        // Establish socket
        try {
            var socket = io.connect();
        } catch (e) {
            throw e;
        }

        // Status for texting/video
        var setStatus = function (s) {
            status.textContent = s;
            if (s !== statusDefault) {
                var delay = setTimeout(function () {
                    setStatus(statusDefault);
                    clearInterval(delay);
                }, 5000);
            }
        };

        // Test button
        document.getElementById("host-button").onclick = function () {
            if (YTPlayerIsReady) {
                socket.emit('user_host_request', { time: YTPlayer.getCurrentTime, status: YTPlayerStatus });
            } else {
                setStatus('Your player is not ready');
            }
        };

        // Emit socket after api is ready
        function onYouTubeIframeAPIReady() {
            if (socket != null) {
                socket.emit('user_youtube_player_status', { status: 1 });
                console.log('Youtube player loaded');
            }
        };

        // Repeatedly send local video progress
        function sendVideoProgress() {
            if (YTPlayerIsReady) {
                if (socket !== undefined && YTPlayerStatus !== YT.PlayerState.PAUSED) {
                    socket.emit('user_video_progress', { time: YTPlayer.getCurrentTime(), status: YTPlayerStatus });
                }
                var delay = setTimeout(function () {
                    sendVideoProgress();
                    clearInterval(delay);
                }, 1000);
            }
        };

        function onPlayerReady(event) {
            event.target.playVideo();
            YTPlayerStatus = 1;
            YTPlayerIsReady = true;
            sendVideoProgress();
        }

        function onPlayerStateChange(event) {
            if (event.data != YTPlayerStatus && event.data !== 3) {
                console.log(event.data);
                YTPlayerStatus = event.data;
                socket.emit('user_video_progress', { time: YTPlayer.getCurrentTime(), status: YTPlayerStatus });
            }
        }

        function stopVideo() {
            YTPlayer.stopVideo();
        }

        // Main body
        (function () {

            setStatus('Testing...');

            // Socket events
            if (socket != undefined) {
                console.log('ok');

                // Listen for new chat message
                socket.on('new_chat_message', function (payload) {
                    if (payload.length) {
                        // Loop through messages
                        for (var x = 0; x < payload.length; x = x + 1) {
                            var message = document.createElement('div');
                            message.setAttribute('class', 'chat-message');
                            message.textContent = payload[x].name + ': ' + payload[x].message;

                            // Append
                            messages.appendChild(message);
                            messages.insertBefore(message, messages.firstChild);
                        }
                    }
                });

                // Listen for new video url
                socket.on('new_video_url', function (payload) {
                    console.log(payload);
                    if (payload.length) {
                        // Loop through messages
                        for (var x = 0; x < payload.length; x = x + 1) {
                            var url = document.createElement('div');
                            url.setAttribute('class', 'new_video_url');
                            url.textContent = payload[x].url;

                            // Append
                            playlist.appendChild(url);
                            playlist.insertBefore(url, playlist.firstChild);
                        }
                    }
                });

                // Listen for a status
                socket.on('status', function (payload) {
                    setStatus((typeof payload === 'object') ? payload.message : payload);
                    if (payload.clear === true) {
                        textarea.value = '';
                    }
                });

                // Listen for chat input
                textarea.addEventListener('keydown', function (event) {
                    var self = this,
                        name = chatName.value;
                    if (event.which === 13 && event.shiftKey === false) {
                        socket.emit('user_chat_message', {
                            name: name,
                            message: self.value
                        });
                    }
                });

                // Listen for url input
                playlistInput.addEventListener('keydown', function (event) {
                    var self = this,
                        name = chatName.value;
                    if (event.which === 13 && event.shiftKey === false) {
                        socket.emit('user_video_url', {
                            name: name,
                            url: self.value
                        })
                    }
                });

                // Listen for generating video
                var self = this;
                socket.on('new_video_id', function (payload) {
                    console.log('new player');
                    if (YTPlayer !== undefined) {
                        YTPlayer.destroy();
                        YTPlayerIsReady = false;
                    }
                    self.YTPlayer = new YT.Player('video-placeholder', {
                        height: '390',
                        width: '640',
                        videoId: payload.id,
                        playerVars: { 'autoplay': 1, 'controls': 1 },
                        events: {
                            'onReady': self.onPlayerReady,
                            'onStateChange': self.onPlayerStateChange
                        }
                    });
                });

                // Listen for force sync
                socket.on('host_video_progress', function (payload) {
                    console.log('Force sync recieved' + payload.time + 'status: ' + payload.status);
                    hostId.textContent = payload.hostId;
                    if (!YTPlayerIsReady) {
                        return;
                    }
                    switch (payload.status) {
                        case 1:
                            if (YTPlayerStatus !== 1) {
                                YTPlayer.playVideo();
                                YTPlayerStatus = 1;
                            }
                            break;
                        case 2:
                            YTPlayer.pauseVideo();
                            YTPlayerStatus = 2;
                            console.log('paused');
                            break;
                        default: break;
                    }
                    if (YTPlayerIsReady) {
                        YTPlayer.seekTo(payload.time, true);
                    }
                });
            }
        })();
    </script>
</body>

</html>