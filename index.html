<html>

<head>
    <title> EXP cinema</title>
    <link rel="stylesheet" href="css/index.css">
</head>

<body>
    <div class="chat">
        <input type="text" class="chat-name" placeholder="Enter your name" value="">
        <div class="chat-messages"></div>
        <textarea class="chat-textarea" placholder="Type your message"></textarea>
        <div class="chat-status">
            Status: <span>Idle</span>
        </div>
    </div>
    <div class="video">
        <div class="video-playlist"></div>
        <input class="video-input" type="text" placeholder="Enter youtube url">
        <div id="video-placeholder"></div>
    </div>
    <button id="hostButton" type="button">Become host</button>
    <script src="/socket.io/socket.io.js"></script>
    <script>
        // Video Player
        var player;
        var playerIsReady = false;

        var tag = document.createElement('script');

        tag.src = "https://www.youtube.com/iframe_api";
        var firstScriptTag = document.getElementsByTagName('script')[0];
        firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);

        // Establish socket
        try {
            var socket = io.connect();
        } catch (e) {
            throw e;
        }

        // Test button
        document.getElementById("hostButton").onclick = function () {
            socket.emit('user_host_request', 1);
        };

        // Emit socket after api is ready
        function onYouTubeIframeAPIReady() {
            if (socket != null) {
                socket.emit('user_youtube_player_status', { status: 1 });
                console.log('loaded');
            }
        };

        function sendVideoProgress() {
            if (playerIsReady) {
                if (socket !== undefined) {
                    socket.emit('user_video_progress', { time: player.getCurrentTime() });
                }
                var delay = setTimeout(function () {
                    sendVideoProgress();
                    clearInterval(delay);
                }, 1000);
            }
        };
        function onPlayerReady(event) {
            event.target.playVideo();
            playerIsReady = true;
            sendVideoProgress();
        }

        var done = false;
        function onPlayerStateChange(event) {
            if (event.data == YT.PlayerState.PLAYING && !done) {
                done = true;
            }
        }
        function stopVideo() {
            player.stopVideo();
        }

        // Main body
        (function () {
            var getNode = function (s) {
                return document.querySelector(s);
            },
                status = getNode('.chat-status span'),
                messages = getNode('.chat-messages'),
                textarea = getNode('.chat textarea'),
                chatName = getNode('.chat-name'),
                statusDefault = status.textContent,
                playlist = getNode('.video-playlist'),
                playlistInput = getNode('.video-input');

            // Status for texting/video
            setStatus = function (s) {
                status.textContent = s;
                if (s !== statusDefault) {
                    var delay = setTimeout(function () {
                        setStatus(statusDefault);
                        clearInterval(delay);
                    }, 5000);
                }
            };

            setStatus('Testing...');
            
            // Socket events
            if (socket != undefined) {
                console.log('ok');
                
                // Listen for output for chat
                socket.on('new_chat_message', function (payload) {
                    if (payload.length) {
                        // Loop through messages
                        for (var x = 0; x < payload.length; x = x + 1) {
                            var message = document.createElement('div');
                            message.setAttribute('class', 'chat-message');
                            message.textContent = payload[x].name + ': ' + payload[x].message;

                            // Append
                            messages.appendChild(message);
                            messages.insertBefore(message, messages.firstChild);
                        }
                    }
                });

                // Listen for output for video
                socket.on('new_video_url', function (payload) {
                    if (payload.length) {
                        // Loop through messages
                        for (var x = 0; x < payload.length; x = x + 1) {
                            var url = document.createElement('div');
                            url.setAttribute('class', 'new_video_url');
                            url.textContent = payload[x].url;

                            // Append
                            playlist.appendChild(url);
                            playlist.insertBefore(url, playlist.firstChild);
                        }
                    }
                });

                // Listen for a status
                socket.on('status', function (payload) {
                    setStatus((typeof payload === 'object') ? payload.message : payload);
                    if (payload.clear === true) {
                        textarea.value = '';
                    }
                });
                // Listen for keydown
                textarea.addEventListener('keydown', function (event) {
                    var self = this,
                        name = chatName.value;
                    if (event.which === 13 && event.shiftKey === false) {
                        socket.emit('user_chat_message', {
                            name: name,
                            message: self.value
                        });
                    }
                });

                playlistInput.addEventListener('keydown', function (event) {
                    var self = this,
                        name = chatName.value;
                    if (event.which === 13 && event.shiftKey === false) {
                        socket.emit('user_video_url', {
                            name: name,
                            url: self.value
                        })
                    }
                });
                var self = this;
                socket.on('new_video_id', function (payload) {
                    console.log('new player');
                    if(player !== undefined){
                        player.destroy();
                        playerIsReady = false;
                    }
                    self.player = new YT.Player('video-placeholder', {
                        height: '390',
                        width: '640',
                        videoId: payload.id,
                        playerVars: { 'autoplay': 1, 'controls': 1 },
                        events: {
                            'onReady': self.onPlayerReady,
                            'onStateChange': self.onPlayerStateChange
                        }
                    });
                });

                socket.on('host_video_progress', function (payload) {
                    console.log('Force sync recieved' + payload.time);
                    if (playerIsReady) {
                        player.seekTo(payload.time, true);
                    }
                });
            }
        })();
    </script>
</body>

</html>